import d from"https://cdn.jsdelivr.net/npm/@line/liff@2.23.2/+esm";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))r(e);new MutationObserver(e=>{for(const t of e)if(t.type==="childList")for(const s of t.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function i(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?t.credentials="include":e.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function r(e){if(e.ep)return;e.ep=!0;const t=i(e);fetch(e.href,t)}})();const a="https://script.google.com/macros/s/AKfycby58aoJJ7ml_6Xmh_EzirrPxNnqscbMjPU24ZDc0abyrAGGXNgnFehPFaluBaHoXmgXyA/exec",l="https://script.google.com/macros/s/AKfycbyztna3JATsl16tEPwFKIJgZm1GGsFAGS0bI-pAvFdPjnaTuTzNnSqHK8QPHL7Xyz8e/exec";async function u(){try{await d.init({liffId:"2009177086-5AGq54Qb"}),d.isLoggedIn()?m():d.login()}catch(n){console.error("LIFF 初始化失敗",n),document.getElementById("loadingView").innerText="系統初始化失敗，請稍後再試"}}async function m(){try{const n=await d.getProfile(),o=n.userId,r=await(await fetch(`${a}?userid=${o}`)).json();document.getElementById("loadingView").classList.add("hidden"),r.isBound?(document.getElementById("userName").innerText=`你好，${n.displayName}！`,document.getElementById("boundView").classList.remove("hidden"),fetch(`${l}?uid=${o}`).then(e=>e.json()).then(e=>{if(e.status==="success"){document.getElementById("subscriptionDuration").innerText=`訂閱 ${e.duration}`;const t=e.months,s=12,c=s-t;document.getElementById("currentMonth").textContent=t,document.getElementById("remainingMonths").textContent=c,document.getElementById("progressFill").style.width=`${t/s*100}%`}else document.getElementById("subscriptionDuration").innerText="查詢異常，請洽詢官方LINE帳號"}).catch(()=>{document.getElementById("subscriptionDuration").innerText="查詢異常，請洽詢官方LINE帳號"})):document.getElementById("unboundView").classList.remove("hidden")}catch(n){console.error("檢查狀態失敗",n),document.getElementById("loadingView").classList.add("hidden"),document.getElementById("unboundView").classList.remove("hidden")}}async function f(){const n=document.getElementById("submitBtn"),o=document.getElementById("orderId").value,i=document.getElementById("mobile").value,r=document.getElementById("statusMsg");if(!o||!i){Swal.fire("提醒","請填寫訂單編號與手機號碼","warning");return}n.disabled=!0,r.innerText="正在驗證資訊...";const e=await d.getProfile(),t=new URLSearchParams;t.append("orderId",o),t.append("mobile",i),t.append("userid",e.userId),t.append("displayName",e.displayName),t.append("pictureUrl",e.pictureUrl);try{const c=await(await fetch(a,{method:"POST",body:t})).json();c.status===200?Swal.fire({title:"成功！",text:"訂單綁定成功",icon:"success",confirmButtonColor:"#be9f74"}).then(()=>{location.reload()}):(Swal.fire("綁定失敗",c.message,"error"),r.innerText=c.message,n.disabled=!1)}catch{Swal.fire("連線異常","請稍後再試","error"),n.disabled=!1}}document.getElementById("submitBtn").addEventListener("click",f);u();
