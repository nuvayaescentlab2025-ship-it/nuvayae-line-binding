<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訂單綁定系統</title>
</head>
<body>
    <div id="app">
        <h2>訂單資訊綁定</h2>
        <form id="bindingForm">
            <label>請輸入您的訂單編號：</label><br>
            <input type="text" id="orderId" placeholder="例如：20260220001" required><br><br>
            <button type="button" id="submitBtn">提交並綁定 LINE</button>
        </form>
        <p id="status"></p>
    </div>

    <script type="module">
        import liff from "@line/liff";

        async function initLiff() {
            try {
                // 初始化並要求 Email 權限 (需在 LINE 後台開啟權限)
                await liff.init({ liffId: "2009177086-5AGq54Qb" });
                if (!liff.isLoggedIn()) {
                    liff.login();
                }
            } catch (err) {
                console.error("LIFF 初始化失敗", err);
            }
        }

        async function submitForm() {
            const orderId = document.getElementById('orderId').value;
            if (!orderId) { alert("請輸入訂單編號"); return; }

            try {
                // 1. 取得基本 Profile (UID, 顯示名稱, 大頭照)
                const profile = await liff.getProfile();
                
                // 2. 取得 Email (選填，需在 LINE 後台申請權限並在登入時要求 scope)
                const userEmail = liff.getDecodedIDToken() ? liff.getDecodedIDToken().email : "未授權";

                const formData = new URLSearchParams();
                formData.append('orderId', orderId);
                formData.append('userid', profile.userId);
                formData.append('displayName', profile.displayName);
                formData.append('pictureUrl', profile.pictureUrl);
                formData.append('email', userEmail);

                fetch('你的GAS_API網址', {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors'
                }).then(() => {
                    alert('綁定成功！');
                    liff.closeWindow();
                });
            } catch (err) {
                console.error("抓取 Profile 失敗", err);
                alert("無法取得 LINE 資訊，請稍後再試");
            }
        }

        document.getElementById('submitBtn').addEventListener('click', submitForm);
        initLiff();
    </script>
</body>
</html>
