<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç…–æ„ | è¨‚é–±ç³»çµ±</title>
    
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div id="app">
        <div id="loadingView" class="loading">æ­£åœ¨ç¢ºèªæœƒå“¡ç‹€æ…‹...</div>

        <div id="unboundView" class="hidden">
            <h2 style="color: #be9f74;">è¨‚å–®è³‡è¨Šç¶å®š</h2>
            <p>è«‹è¼¸å…¥æ‚¨çš„è¨‚è³¼è³‡è¨Šä»¥é–‹é€šæœƒå“¡</p>
            <form id="bindingForm">
                <input type="text" id="orderId" placeholder="è¨‚å–®ç·¨è™Ÿ (ä¾‹å¦‚ï¼š20260220xxx)" required>
                <input type="tel" id="mobile" placeholder="è¨‚è³¼äººæ‰‹æ©Ÿè™Ÿç¢¼" required pattern="09[0-9]{8}" maxlength="10" inputmode="numeric">
                <button type="button" id="submitBtn">æäº¤ä¸¦ç¶å®š LINE</button>
            </form>
        </div>

        <div id="boundView" class="hidden">
            <h2 id="userName" style="color: #be9f74;">æ­¡è¿å›ä¾†ï¼</h2>
            <p id="subscriptionDuration" style="font-size: 13px; color: #aaa;"></p>
            <div class="progress-card hidden">
              <div class="progress-header">
                <span class="progress-fraction">
                  <span id="currentMonth">æŸ¥è©¢ä¸­</span><span class="slash">/</span><span>12</span>
                </span>
                <span class="progress-unit">å€‹æœˆ</span>
              </div>
              <div class="progress-track">
                <div class="progress-fill" id="progressFill"></div>
              </div>
              <p class="progress-headline">
                æœ€å¾Œ <strong id="remainingMonths">æŸ¥è©¢ä¸­</strong> å€‹æœˆï¼Œå®Œæˆæ‰€æœ‰æ¬Šè§£é–ï¼Œ<br>
                é ˜å› <strong>$1,980</strong> ä¿è­‰é‡‘ã€‚
              </p>
              <p class="progress-hint">å®Œæˆå¾Œå³äº«æ–°å¹´åº¦æ“´é¦™å„€çºŒé ˜è³‡æ ¼</p>
            </div>
            <p>æ‚¨å·²å…·å‚™æœƒå“¡è³‡æ ¼ï¼Œè«‹é¸æ“‡æœå‹™ï¼š</p>
            <div class="link-group">
                <a href="https://nuvayaescentlab.cashier.ecpay.com.tw">âœ¨ é€²å…¥ VIP æœƒå“¡å°ˆå€</a>
                <a href="https://nuvayaescentlab.cashier.ecpay.com.tw/product/000000000912859">ğŸŒ¬ï¸ é ˜å– | è¨‚é–±åˆ¶å°ˆå±¬æ“´é¦™å„€</a>
            </div>
        </div>

        <p id="statusMsg" style="margin-top: 15px; font-size: 14px; color: #888;"></p>
    </div>

    <script type="module">
        import liff from "https://cdn.jsdelivr.net/npm/@line/liff@2.23.2/+esm";

        const GAS_URL = 'https://script.google.com/macros/s/AKfycby58aoJJ7ml_6Xmh_EzirrPxNnqscbMjPU24ZDc0abyrAGGXNgnFehPFaluBaHoXmgXyA/exec';
        const DURATION_URL = 'https://script.google.com/macros/s/AKfycbyztna3JATsl16tEPwFKIJgZm1GGsFAGS0bI-pAvFdPjnaTuTzNnSqHK8QPHL7Xyz8e/exec';

        async function initLiff() {
            try {
                await liff.init({ liffId: "2009177086-5AGq54Qb" });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    // é‡è¦ï¼šç™»å…¥å¾ŒåŸ·è¡Œç‹€æ…‹æª¢æŸ¥
                    checkSubscriptionStatus();
                }
            } catch (err) {
                console.error("LIFF åˆå§‹åŒ–å¤±æ•—", err);
                document.getElementById('loadingView').innerText = "ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
            }
        }

        // 1. æª¢æŸ¥è¨‚é–±ç‹€æ…‹ (doGet)
        async function checkSubscriptionStatus() {
            try {
                const profile = await liff.getProfile();
                const userId = profile.userId;
                
                // é€™è£¡ç™¼é€ GET è«‹æ±‚çµ¦ GAS
                const response = await fetch(`${GAS_URL}?userid=${userId}`);
                const result = await response.json();

                if (result.isBound) {
                    // æŸ¥è©¢è¨‚é–±æ™‚é•·ï¼Œç­‰å¾…å®Œæˆå¾Œå†é¡¯ç¤º
                    try {
                        const dr = await fetch(`${DURATION_URL}?uid=${userId}`);
                        const d = await dr.json();
                        if (d.status === 'success') {
                            document.getElementById('subscriptionDuration').innerText = `è¨‚é–± ${d.duration}`;
                            const months = d.months;
                            const total = 12;
                            const remaining = total - months;
                            document.getElementById('currentMonth').textContent = months;
                            document.getElementById('remainingMonths').textContent = remaining;
                            document.getElementById('progressFill').style.width =
                                `${(months / total) * 100}%`;
                            document.querySelector('.progress-card').classList.remove('hidden');
                        } else {
                            document.getElementById('subscriptionDuration').innerText = 'æŸ¥è©¢ç•°å¸¸ï¼Œè«‹æ´½è©¢å®˜æ–¹LINEå¸³è™Ÿ';
                        }
                    } catch {
                        document.getElementById('subscriptionDuration').innerText = 'æŸ¥è©¢ç•°å¸¸ï¼Œè«‹æ´½è©¢å®˜æ–¹LINEå¸³è™Ÿ';
                    }

                    // å…©å€‹æŸ¥è©¢éƒ½å®Œæˆï¼Œéš±è—è¼‰å…¥ä¸¦é¡¯ç¤ºå·²ç¶å®šç•«é¢
                    document.getElementById('loadingView').classList.add('hidden');
                    document.getElementById('userName').innerText = `ä½ å¥½ï¼Œ${profile.displayName}ï¼`;
                    document.getElementById('boundView').classList.remove('hidden');
                } else {
                    // éš±è—è¼‰å…¥ä¸­æ–‡å­—
                    document.getElementById('loadingView').classList.add('hidden');
                    // é¡¯ç¤ºæœªç¶å®šç•«é¢
                    document.getElementById('unboundView').classList.remove('hidden');
                }
            } catch (err) {
                console.error("æª¢æŸ¥ç‹€æ…‹å¤±æ•—", err);
                document.getElementById('loadingView').classList.add('hidden');
                document.getElementById('unboundView').classList.remove('hidden');
            }
        }

        // 2. æäº¤ç¶å®š (doPost)
        async function submitForm() {
            const btn = document.getElementById('submitBtn');
            const orderId = document.getElementById('orderId').value;
            const mobile = document.getElementById('mobile').value;
            const statusMsg = document.getElementById('statusMsg');

            if (!orderId || !mobile) {
                Swal.fire('æé†’', 'è«‹å¡«å¯«è¨‚å–®ç·¨è™Ÿèˆ‡æ‰‹æ©Ÿè™Ÿç¢¼', 'warning');
                return;
            }

            btn.disabled = true;
            statusMsg.innerText = "æ­£åœ¨é©—è­‰è³‡è¨Š...";

            const profile = await liff.getProfile();
            const formData = new URLSearchParams();
            formData.append('orderId', orderId);
            formData.append('mobile', mobile);
            formData.append('userid', profile.userId);
            formData.append('displayName', profile.displayName);
            formData.append('pictureUrl', profile.pictureUrl);

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 200) {
                    Swal.fire({
                        title: 'æˆåŠŸï¼',
                        text: 'è¨‚å–®ç¶å®šæˆåŠŸ',
                        icon: 'success',
                        confirmButtonColor: '#be9f74'
                    }).then(() => {
                        location.reload(); // é‡æ–°æ•´ç†ï¼Œé‡æ–°è·‘ä¸€æ¬¡ checkSubscriptionStatus
                    });
                } else {
                    Swal.fire('ç¶å®šå¤±æ•—', result.message, 'error');
                    statusMsg.innerText = result.message;
                    btn.disabled = false;
                }
            } catch (err) {
                Swal.fire('é€£ç·šç•°å¸¸', 'è«‹ç¨å¾Œå†è©¦', 'error');
                btn.disabled = false;
            }
        }

        document.getElementById('submitBtn').addEventListener('click', submitForm);
        initLiff();
    </script>
</body>
</html>
