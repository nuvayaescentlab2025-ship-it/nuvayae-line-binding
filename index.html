<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訂單綁定系統</title>
</head>
<body>
    <div id="app">
        <h2>訂單資訊綁定</h2>
        <form id="bindingForm">
            <label>請輸入您的訂單編號：</label><br>
            <input type="text" id="orderId" placeholder="例如：20260220001" required><br><br>
            <button type="button" id="submitBtn">提交並綁定 LINE</button>
        </form>
        <p id="status"></p>
    </div>

    <script type="module">
        import liff from "@line/liff";

        async function initLiff() {
            try {
                // 初始化並要求 Email 權限 (需在 LINE 後台開啟權限)
                await liff.init({ liffId: "2009177086-5AGq54Qb" });
                if (!liff.isLoggedIn()) {
                    liff.login();
                }
            } catch (err) {
                console.error("LIFF 初始化失敗", err);
            }
        }

        async function submitForm() {
            const orderId = document.getElementById('orderId').value;
            const profile = await liff.getProfile();
            const userEmail = liff.getDecodedIDToken() ? liff.getDecodedIDToken().email : "未授權";
        
            const formData = new URLSearchParams();
            formData.append('orderId', orderId);
            formData.append('userid', profile.userId);
            formData.append('displayName', profile.displayName);
            formData.append('pictureUrl', profile.pictureUrl);
            formData.append('email', userEmail);
        
            // 注意：這裡移除了 mode: 'no-cors'，因為我們需要讀取 GAS 回傳的 404 訊息
            fetch('https://script.google.com/macros/s/AKfycby58aoJJ7ml_6Xmh_EzirrPxNnqscbMjPU24ZDc0abyrAGGXNgnFehPFaluBaHoXmgXyA/exec', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.status === 200) {
                    alert('✅ 綁定成功！');
                    liff.closeWindow();
                } else {
                    alert('❌ 錯誤：' + result.message);
                }
            })
            .catch(err => {
                // 如果 GAS 依然有 CORS 問題，這裡會進 catch，但資料通常還是有送出
                console.error(err);
            });
        }

        document.getElementById('submitBtn').addEventListener('click', submitForm);
        initLiff();
    </script>
</body>
</html>
