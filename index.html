<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç²¾æ²¹æ©Ÿè¨‚é–±æœƒå“¡ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; padding: 20px; background-color: #f4f7f6; }
        #app { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .hidden { display: none; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 12px; background-color: #00b900; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; }
        button:disabled { background-color: #ccc; }
        button:active { transform: scale(0.98); }
        .link-group a { display: block; margin: 10px 0; padding: 12px; background-color: #007bff; color: white; text-decoration: none; border-radius: 8px; font-weight: bold; }
        .loading { color: #666; font-style: italic; }
    </style>
</head>
<body>
    <div id="app">
        <div id="loadingView" class="loading">æ­£åœ¨ç¢ºèªæœƒå“¡ç‹€æ…‹...</div>

        <div id="unboundView" class="hidden">
            <h2>è¨‚å–®è³‡è¨Šç¶å®š</h2>
            <p style="font-size: 14px; color: #666;">è«‹è¼¸å…¥æ‚¨çš„è¨‚è³¼è³‡è¨Šä»¥é–‹é€šæœƒå“¡</p>
            <form id="bindingForm">
                <input type="text" id="orderId" placeholder="è¨‚å–®ç·¨è™Ÿ (ä¾‹å¦‚ï¼š20260220xxx)" required>
                <input type="tel" id="mobile" placeholder="è¨‚è³¼äººæ‰‹æ©Ÿè™Ÿç¢¼" required pattern="09[0-9]{8}" maxlength="10" inputmode="numeric">
                <button type="button" id="submitBtn">æäº¤ä¸¦ç¶å®š LINE</button>
            </form>
        </div>

        <div id="boundView" class="hidden">
            <h2 id="userName">æ­¡è¿å›ä¾†ï¼</h2>
            <p>æ‚¨å·²å…·å‚™æœƒå“¡è³‡æ ¼ï¼Œè«‹é¸æ“‡æœå‹™ï¼š</p>
            <div class="link-group">
                <a href="https://your-shop-link.com">ğŸ›’ å‰å¾€å•†åŸæ›è³¼ç²¾æ²¹</a>
                <a href="https://your-support-link.com">ğŸ› ï¸ è¨‚é–±æ©Ÿå™¨ç¶­è­·æœå‹™</a>
            </div>
        </div>

        <p id="statusMsg" style="margin-top: 15px; font-size: 14px;"></p>
    </div>

    <script type="module">
        import liff from "https://cdn.jsdelivr.net/npm/@line/liff@2.23.2/+esm";

        const GAS_URL = 'https://script.google.com/macros/s/AKfycby58aoJJ7ml_6Xmh_EzirrPxNnqscbMjPU24ZDc0abyrAGGXNgnFehPFaluBaHoXmgXyA/exec';

        async function initLiff() {
            try {
                await liff.init({ liffId: "2009177086-5AGq54Qb" });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    checkSubscriptionStatus();
                }
            } catch (err) {
                console.error("LIFF åˆå§‹åŒ–å¤±æ•—", err);
                document.getElementById('loadingView').innerText = "ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
            }
        }

        async function checkSubscriptionStatus() {
            const profile = await liff.getProfile();
            const userId = profile.userId;
            
            try {
                const response = await fetch(`${GAS_URL}?userid=${userId}`);
                const result = await response.json();
                document.getElementById('loadingView').classList.add('hidden');
                
                if (result.isBound) {
                    document.getElementById('userName').innerText = `ä½ å¥½ï¼Œ${profile.displayName}ï¼`;
                    document.getElementById('boundView').classList.remove('hidden');
                } else {
                    document.getElementById('unboundView').classList.remove('hidden');
                }
            } catch (err) {
                document.getElementById('loadingView').classList.add('hidden');
                document.getElementById('unboundView').classList.remove('hidden');
            }
        }

        async function submitForm() {
            const btn = document.getElementById('submitBtn');
            const orderId = document.getElementById('orderId').value;
            const mobile = document.getElementById('mobile').value;
            const statusMsg = document.getElementById('statusMsg');
        
            if (!orderId || !mobile) {
                Swal.fire('æé†’', 'è«‹å®Œæ•´å¡«å¯«è¨‚å–®ç·¨è™Ÿèˆ‡æ‰‹æ©Ÿè™Ÿç¢¼', 'warning');
                return;
            }
        
            btn.disabled = true;
            statusMsg.innerText = "æ­£åœ¨é©—è­‰è³‡è¨Š...";
        
            const profile = await liff.getProfile();
            const formData = new URLSearchParams();
            formData.append('orderId', orderId);
            formData.append('mobile', mobile);
            formData.append('userid', profile.userId);
            formData.append('displayName', profile.displayName);
            formData.append('pictureUrl', profile.pictureUrl);
        
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
        
                if (result.status === 200) {
                    // 2. ä½¿ç”¨ SweetAlert2 å–ä»£åŸæœ¬çš„ alert
                    Swal.fire({
                        title: 'æˆåŠŸï¼',
                        text: 'è¨‚å–®ç¶å®šæˆåŠŸ',
                        icon: 'success',
                        confirmButtonColor: '#00b900',
                        confirmButtonText: 'ç¢ºå®š'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire('ç¶å®šå¤±æ•—', result.message, 'error');
                    statusMsg.innerText = result.message;
                    btn.disabled = false;
                }
            } catch (err) {
                Swal.fire('é€£ç·šç•°å¸¸', 'è«‹ç¢ºèªç¶²è·¯ç‹€æ…‹å¾Œå†è©¦ä¸€æ¬¡', 'error');
                btn.disabled = false;
            }
        }
        
        document.getElementById('submitBtn').addEventListener('click', submitForm);
        initLiff();
    </script>
</body>
</html>
