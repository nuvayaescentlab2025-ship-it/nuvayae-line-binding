<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç²¾æ²¹æ©Ÿè¨‚é–±æœƒå“¡ç³»çµ±</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; padding: 20px; background-color: #f4f7f6; }
        #app { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .hidden { display: none; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background-color: #00b900; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:disabled { background-color: #ccc; }
        .link-group a { display: block; margin: 10px 0; padding: 12px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px; }
        .loading { color: #666; font-style: italic; }
    </style>
</head>
<body>
    <div id="app">
        <div id="loadingView" class="loading">æ­£åœ¨ç¢ºèªæœƒå“¡ç‹€æ…‹...</div>

        <div id="unboundView" class="hidden">
            <h2>è¨‚å–®è³‡è¨Šç¶å®š</h2>
            <p style="font-size: 14px; color: #666;">è«‹è¼¸å…¥ä¸€å€‹æœˆå…§çš„è¨‚å–®ç·¨è™Ÿä»¥é–‹é€šæœƒå“¡æœå‹™</p>
            <form id="bindingForm">
                <input type="text" id="orderId" placeholder="è«‹è¼¸å…¥è¨‚å–®ç·¨è™Ÿ" required>
                <button type="button" id="submitBtn">æäº¤ä¸¦ç¶å®š LINE</button>
            </form>
        </div>

        <div id="boundView" class="hidden">
            <h2 id="userName">æ­¡è¿å›ä¾†ï¼</h2>
            <p>æ‚¨å·²å…·å‚™æœƒå“¡è³‡æ ¼ï¼Œè«‹é¸æ“‡æœå‹™ï¼š</p>
            <div class="link-group">
                <a href="https://your-shop-link.com">ğŸ›’ å‰å¾€å•†åŸæ›è³¼ç²¾æ²¹</a>
                <a href="https://your-support-link.com">ğŸ› ï¸ è¨‚é–±æ©Ÿå™¨ç¶­è­·æœå‹™</a>
            </div>
        </div>

        <p id="statusMsg" style="margin-top: 15px; font-size: 14px;"></p>
    </div>

    <script type="module">
        import liff from "https://cdn.jsdelivr.net/npm/@line/liff@2.23.2/+esm";

        const GAS_URL = 'https://script.google.com/macros/s/AKfycby58aoJJ7ml_6Xmh_EzirrPxNnqscbMjPU24ZDc0abyrAGGXNgnFehPFaluBaHoXmgXyA/exec';

        async function initLiff() {
            try {
                await liff.init({ liffId: "2009177086-5AGq54Qb" });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    checkSubscriptionStatus();
                }
            } catch (err) {
                console.error("LIFF åˆå§‹åŒ–å¤±æ•—", err);
                document.getElementById('loadingView').innerText = "ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
            }
        }

        // 1. æª¢æŸ¥è¨‚é–±ç‹€æ…‹ (å‘¼å« GAS doGet)
        async function checkSubscriptionStatus() {
            const profile = await liff.getProfile();
            const userId = profile.userId;
            
            try {
                const response = await fetch(`${GAS_URL}?userid=${userId}`);
                const result = await response.json();

                document.getElementById('loadingView').classList.add('hidden');
                
                if (result.isBound) {
                    // å·²ç¶å®šä¸”åœ¨æ•ˆæœŸå…§
                    document.getElementById('userName').innerText = `ä½ å¥½ï¼Œ${profile.displayName}ï¼`;
                    document.getElementById('boundView').classList.remove('hidden');
                } else {
                    // æœªç¶å®šæˆ–å·²éæœŸ
                    document.getElementById('unboundView').classList.remove('hidden');
                }
            } catch (err) {
                console.error("æª¢æŸ¥ç‹€æ…‹å¤±æ•—", err);
                // ç™¼ç”ŸéŒ¯èª¤æ™‚é è¨­é¡¯ç¤ºè¡¨å–®
                document.getElementById('loadingView').classList.add('hidden');
                document.getElementById('unboundView').classList.remove('hidden');
            }
        }

        // 2. æäº¤ç¶å®šè¡¨å–® (å‘¼å« GAS doPost)
        async function submitForm() {
            const btn = document.getElementById('submitBtn');
            const orderId = document.getElementById('orderId').value;
            const statusMsg = document.getElementById('statusMsg');

            if (!orderId) return alert('è«‹è¼¸å…¥è¨‚å–®ç·¨è™Ÿ');

            btn.disabled = true;
            statusMsg.innerText = "æ­£åœ¨é©—è­‰è¨‚å–®...";

            const profile = await liff.getProfile();
            const userEmail = liff.getDecodedIDToken() ? liff.getDecodedIDToken().email : "æœªæˆæ¬Š";
        
            const formData = new URLSearchParams();
            formData.append('orderId', orderId);
            formData.append('userid', profile.userId);
            formData.append('displayName', profile.displayName);
            formData.append('pictureUrl', profile.pictureUrl);
            formData.append('email', userEmail);
        
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 200) {
                    alert('âœ… ç¶å®šæˆåŠŸï¼');
                    location.reload(); // é‡æ–°è¼‰å…¥é é¢ä»¥åˆ‡æ›è‡³åŠŸèƒ½é¸å–®è¦–åœ–
                } else {
                    alert('âŒ éŒ¯èª¤ï¼š' + result.message);
                    statusMsg.innerText = result.message;
                    btn.disabled = false;
                }
            } catch (err) {
                console.error(err);
                alert('ç³»çµ±é€£ç·šç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦');
                btn.disabled = false;
            }
        }

        document.getElementById('submitBtn').addEventListener('click', submitForm);
        initLiff();
    </script>
</body>
</html>
